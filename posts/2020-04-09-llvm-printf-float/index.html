<!doctype html><html lang=ja><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="caphosra"><meta name=description content="LLVMのC++ APIを使用し、printfを呼び出してfloat型の変数を表示するLLVM IRを出力するまで行います。"><meta name=keywords content="llvm,printf,float,ir,c++"><meta name=twitter:card content="summary"><meta name=twitter:image content="https://caphosra.net/images/icon.webp"><meta name=twitter:title content="[LLVM] printfでFloat型の足し算の結果を表示する"><meta name=twitter:description content="LLVMのC++ APIを使用し、printfを呼び出してfloat型の変数を表示するLLVM IRを出力するまで行います。"><meta property="og:url" content="https://caphosra.net/posts/2020-04-09-llvm-printf-float/"><meta property="og:site_name" content="caphosra note"><meta property="og:title" content="[LLVM] printfでFloat型の足し算の結果を表示する"><meta property="og:description" content="LLVMのC++ APIを使用し、printfを呼び出してfloat型の変数を表示するLLVM IRを出力するまで行います。"><meta property="og:locale" content="ja"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-04-09T13:06:28+09:00"><meta property="article:modified_time" content="2024-01-07T13:58:55+09:00"><meta property="article:tag" content="CPlusPlus"><meta property="article:tag" content="LLVM"><base href=https://caphosra.net/posts/2020-04-09-llvm-printf-float/><title>[LLVM] printfでFloat型の足し算の結果を表示する · caphosra note
</title><link rel=canonical href=https://caphosra.net/posts/2020-04-09-llvm-printf-float/><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css integrity="sha256-l85OmPOjvil/SOvVt3HnSSjzF1TUMyT9eV0c2BzEGzU=" crossorigin=anonymous><style defer>@import 'https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;700&display=swap'</style><link rel=stylesheet href=https://caphosra.net/css/coder.min.70f3e69b472ec0878dad3a4928700ac7d4dc99e9a09a656210c5862dcf0acfe7.css integrity="sha256-cPPmm0cuwIeNrTpJKHAKx9TcmemgmmViEMWGLc8Kz+c=" crossorigin=anonymous media=screen><script src=https://cdn.jsdelivr.net/npm/gist-embed@1.0.3/dist/gist-embed.min.js defer></script><link rel=icon type=image/png href=https://caphosra.net/images/logo/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=https://caphosra.net/images/logo/favicon-16x16.png sizes=16x16><meta name=generator content="Hugo 0.139.3"><style type=text/css>.icon{font-size:2.5em}</style></head><body class=colorscheme-light><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=https://caphosra.net/>caphosra note
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa-solid fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=https://caphosra.net/>About</a></li><li class=navigation-item><a class=navigation-link href=https://caphosra.net/posts/>Blog</a></li><li class=navigation-item><a class=navigation-link href=https://caphosra.net/tags/>Tags</a></li><li class=navigation-item><a class=navigation-link href=https://caphosra.net/archives/>Archives</a></li><li class=navigation-item><a class=navigation-link href=https://github.com/caphosra>GitHub</a></li><li class="navigation-item menu-separator"><span>|</span></li><li class=navigation-item><a href=https://caphosra.net/en/posts/2020-04-09-llvm-printf-float/>English</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://caphosra.net/posts/2020-04-09-llvm-printf-float/>[LLVM] printfでFloat型の足し算の結果を表示する</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa-solid fa-calendar" aria-hidden=true></i>
<time datetime=2020-04-09T13:06:28+09:00>4月 9, 2020
</time></span><span class=reading-time><i class="fa-solid fa-clock" aria-hidden=true></i>
2分で読めます</span></div><div class=tags><i class="fa-solid fa-tag" aria-hidden=true></i>
<span class=tag><a href=https://caphosra.net/tags/cplusplus/>CPlusPlus</a>
</span><span class=separator>•</span>
<span class=tag><a href=https://caphosra.net/tags/llvm/>LLVM</a></span></div></div></header><div class=post-content><p>LLVMのC++ APIを使用して、printfでFloat同士の足し算の結果を表示するLLVM IRを表示するまでを行いたいと思います。</p><h2 id=筆者の環境>筆者の環境
<a class=heading-link href=#%e7%ad%86%e8%80%85%e3%81%ae%e7%92%b0%e5%a2%83><i class="fa-solid fa-link" aria-hidden=true title=見出しへのリンク></i>
<span class=sr-only>見出しへのリンク</span></a></h2><ul><li>LLVM: LLVM 9.0.1</li><li>Compiler: Visual Studio付属のcl.exe</li></ul><h2 id=こんなコードを出力したい>こんなコードを出力したい
<a class=heading-link href=#%e3%81%93%e3%82%93%e3%81%aa%e3%82%b3%e3%83%bc%e3%83%89%e3%82%92%e5%87%ba%e5%8a%9b%e3%81%97%e3%81%9f%e3%81%84><i class="fa-solid fa-link" aria-hidden=true title=見出しへのリンク></i>
<span class=sr-only>見出しへのリンク</span></a></h2><p>以下のC言語のプログラムと同じ動きをするLLVM IRを出力するのが今回の目標です。<br>floatの値を2つ足し算をしてprintfですね。</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#8a93a5;font-style:italic>#include</span> <span style=color:#8a93a5;font-style:italic>&lt;stdio.h&gt;</span><span style=color:#8a93a5;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#e5c07b>int</span> <span style=color:#00b1f7>main</span><span style=color:#abb2bf>()</span> <span style=color:#abb2bf>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e5c07b>float</span> <span style=color:#aa89ea>f1</span> <span style=color:#54b1c7>=</span> <span style=color:#d19a66>3.5</span><span style=color:#abb2bf>;</span>
</span></span><span style=display:flex><span>    <span style=color:#e5c07b>float</span> <span style=color:#aa89ea>f2</span> <span style=color:#54b1c7>=</span> <span style=color:#d19a66>6.4</span><span style=color:#abb2bf>;</span>
</span></span><span style=display:flex><span>    <span style=color:#00b1f7>printf</span><span style=color:#abb2bf>(</span><span style=color:#98c379>&#34;%f + %f = %f</span><span style=color:#d26464;font-weight:700>\n</span><span style=color:#98c379>&#34;</span><span style=color:#abb2bf>,</span> <span style=color:#aa89ea>f1</span><span style=color:#abb2bf>,</span> <span style=color:#aa89ea>f2</span><span style=color:#abb2bf>,</span> <span style=color:#aa89ea>f1</span> <span style=color:#54b1c7>+</span> <span style=color:#aa89ea>f2</span><span style=color:#abb2bf>);</span>
</span></span><span style=display:flex><span>    <span style=color:#76a9f9>return</span> <span style=color:#d19a66>0</span><span style=color:#abb2bf>;</span>
</span></span><span style=display:flex><span><span style=color:#abb2bf>}</span>
</span></span></code></pre></div><h2 id=まずはprintfを定義しよう>まずはprintfを定義しよう
<a class=heading-link href=#%e3%81%be%e3%81%9a%e3%81%afprintf%e3%82%92%e5%ae%9a%e7%be%a9%e3%81%97%e3%82%88%e3%81%86><i class="fa-solid fa-link" aria-hidden=true title=見出しへのリンク></i>
<span class=sr-only>見出しへのリンク</span></a></h2><p>まず、printfの定義について思い出してみましょう。<br>printfは関数の引数として、フォーマットの文字列と、複数の値をとることができます。<br>戻り値はInt32型で帰ってきます。(私は戻り値を使ったことがあまりないです。)</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#e5c07b>int</span> <span style=color:#00b1f7>printf</span><span style=color:#abb2bf>(</span><span style=color:#76a9f9>const</span> <span style=color:#e5c07b>char</span><span style=color:#54b1c7>*</span> <span style=color:#aa89ea>format</span><span style=color:#abb2bf>,</span> <span style=color:#abb2bf>...);</span>
</span></span></code></pre></div><p>それではC++のコードで実装していきます。<br>まず、LLVMのサポートClassを初期化していきましょう。<br>Builderが大文字なのは、LLVMの公式Tutorialで大文字になっていたので、それに慣れてしまったからです。変数名は勿論変えていただいて問題ありません。</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C++ data-lang=C++><span style=display:flex><span><span style=color:#aa89ea>llvm</span><span style=color:#54b1c7>::</span><span style=color:#aa89ea>LLVMContext</span> <span style=color:#aa89ea>context</span><span style=color:#abb2bf>;</span>
</span></span><span style=display:flex><span><span style=color:#aa89ea>llvm</span><span style=color:#54b1c7>::</span><span style=color:#aa89ea>IRBuilder</span><span style=color:#54b1c7>&lt;&gt;</span> <span style=color:#aa89ea>Builder</span><span style=color:#abb2bf>(</span><span style=color:#aa89ea>context</span><span style=color:#abb2bf>);</span>
</span></span><span style=display:flex><span><span style=color:#aa89ea>llvm</span><span style=color:#54b1c7>::</span><span style=color:#aa89ea>Module</span><span style=color:#54b1c7>*</span> <span style=color:#aa89ea>module</span><span style=color:#abb2bf>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#aa89ea>module</span> <span style=color:#54b1c7>=</span> <span style=color:#76a9f9>new</span> <span style=color:#aa89ea>llvm</span><span style=color:#54b1c7>::</span><span style=color:#aa89ea>Module</span><span style=color:#abb2bf>(</span><span style=color:#98c379>&#34;test.ll&#34;</span><span style=color:#abb2bf>,</span> <span style=color:#aa89ea>context</span><span style=color:#abb2bf>);</span>
</span></span></code></pre></div><p>これからいちいち型を定義するのは大変なので、基本的な型はマクロとして簡単にかける様にしておきます。これは本当に我流なのでこのマクロを定義するのが一般的だと思い込まないでください&mldr;</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C++ data-lang=C++><span style=display:flex><span><span style=color:#8a93a5;font-style:italic>#define LLVM_INT8_PTR_TY llvm::Type::getInt8PtrTy(context)
</span></span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic>#define LLVM_INT32_TY llvm::Type::getInt32Ty(context)
</span></span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic>#define LLVM_FLOAT_TY llvm::Type::getFloatTy(context)
</span></span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic>#define LLVM_DOUBLE_TY llvm::Type::getDoubleTy(context)
</span></span></span></code></pre></div><p>これで前準備は終了です。printfの定義に移っていきましょう。<br>まずは関数の"型"を定義します。戻り値の型とvectorに詰めた引数の型を<code>llvm::FunctionType::get</code>に投げて、関数の型を受け取ります。<br>Int8型(Char型)のポインターを引数にして、戻り値をInt32型で返します。</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C++ data-lang=C++><span style=display:flex><span><span style=color:#aa89ea>std</span><span style=color:#54b1c7>::</span><span style=color:#aa89ea>vector</span><span style=color:#54b1c7>&lt;</span><span style=color:#aa89ea>llvm</span><span style=color:#54b1c7>::</span><span style=color:#aa89ea>Type</span><span style=color:#54b1c7>*&gt;</span> <span style=color:#aa89ea>printfFuncArgs</span><span style=color:#abb2bf>;</span>
</span></span><span style=display:flex><span><span style=color:#aa89ea>printfFuncArgs</span><span style=color:#abb2bf>.</span><span style=color:#aa89ea>push_back</span><span style=color:#abb2bf>(</span><span style=color:#aa89ea>LLVM_INT8_PTR_TY</span><span style=color:#abb2bf>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#76a9f9>auto</span> <span style=color:#aa89ea>printfFuncType</span> <span style=color:#54b1c7>=</span> <span style=color:#aa89ea>llvm</span><span style=color:#54b1c7>::</span><span style=color:#aa89ea>FunctionType</span><span style=color:#54b1c7>::</span><span style=color:#aa89ea>get</span><span style=color:#abb2bf>(</span>
</span></span><span style=display:flex><span>    <span style=color:#aa89ea>LLVM_INT32_TY</span><span style=color:#abb2bf>,</span>
</span></span><span style=display:flex><span>    <span style=color:#aa89ea>printfFuncArgs</span><span style=color:#abb2bf>,</span>
</span></span><span style=display:flex><span>    <span style=color:#e5c07b>true</span>
</span></span><span style=display:flex><span><span style=color:#abb2bf>);</span>
</span></span></code></pre></div><p>続けてprintf本体を作成しましょう。以下のようになります。</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C++ data-lang=C++><span style=display:flex><span><span style=color:#76a9f9>auto</span> <span style=color:#aa89ea>printfFunc</span> <span style=color:#54b1c7>=</span> <span style=color:#aa89ea>llvm</span><span style=color:#54b1c7>::</span><span style=color:#aa89ea>Function</span><span style=color:#54b1c7>::</span><span style=color:#aa89ea>Create</span><span style=color:#abb2bf>(</span>
</span></span><span style=display:flex><span>    <span style=color:#aa89ea>printfFuncType</span><span style=color:#abb2bf>,</span>
</span></span><span style=display:flex><span>    <span style=color:#aa89ea>llvm</span><span style=color:#54b1c7>::</span><span style=color:#aa89ea>GlobalValue</span><span style=color:#54b1c7>::</span><span style=color:#aa89ea>ExternalLinkage</span><span style=color:#abb2bf>,</span>
</span></span><span style=display:flex><span>    <span style=color:#98c379>&#34;printf&#34;</span><span style=color:#abb2bf>,</span>
</span></span><span style=display:flex><span>    <span style=color:#aa89ea>module</span><span style=color:#abb2bf>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#aa89ea>printfFunc</span><span style=color:#54b1c7>-&gt;</span><span style=color:#aa89ea>setCallingConv</span><span style=color:#abb2bf>(</span><span style=color:#aa89ea>llvm</span><span style=color:#54b1c7>::</span><span style=color:#aa89ea>CallingConv</span><span style=color:#54b1c7>::</span><span style=color:#aa89ea>C</span><span style=color:#abb2bf>);</span>
</span></span></code></pre></div><h2 id=main関数を定義しよう省略気味>main関数を定義しよう(省略気味)
<a class=heading-link href=#main%e9%96%a2%e6%95%b0%e3%82%92%e5%ae%9a%e7%be%a9%e3%81%97%e3%82%88%e3%81%86%e7%9c%81%e7%95%a5%e6%b0%97%e5%91%b3><i class="fa-solid fa-link" aria-hidden=true title=見出しへのリンク></i>
<span class=sr-only>見出しへのリンク</span></a></h2><p>ここは本質ではないのでコードを書きます。<br>コピペするか、コードの内容を察してください。<br>基本、printfの時と同じなので比べるとわかりやすいかもしれません。</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C++ data-lang=C++><span style=display:flex><span><span style=color:#aa89ea>std</span><span style=color:#54b1c7>::</span><span style=color:#aa89ea>vector</span><span style=color:#54b1c7>&lt;</span><span style=color:#aa89ea>llvm</span><span style=color:#54b1c7>::</span><span style=color:#aa89ea>Type</span><span style=color:#54b1c7>*&gt;</span> <span style=color:#aa89ea>mainFuncArgs</span><span style=color:#abb2bf>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#76a9f9>auto</span> <span style=color:#aa89ea>mainFuncType</span> <span style=color:#54b1c7>=</span> <span style=color:#aa89ea>llvm</span><span style=color:#54b1c7>::</span><span style=color:#aa89ea>FunctionType</span><span style=color:#54b1c7>::</span><span style=color:#aa89ea>get</span><span style=color:#abb2bf>(</span>
</span></span><span style=display:flex><span>    <span style=color:#aa89ea>LLVM_INT32_TY</span><span style=color:#abb2bf>,</span>
</span></span><span style=display:flex><span>    <span style=color:#aa89ea>mainFuncArgs</span><span style=color:#abb2bf>,</span>
</span></span><span style=display:flex><span>    <span style=color:#e5c07b>false</span>
</span></span><span style=display:flex><span><span style=color:#abb2bf>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#76a9f9>auto</span> <span style=color:#aa89ea>mainFunc</span> <span style=color:#54b1c7>=</span> <span style=color:#aa89ea>llvm</span><span style=color:#54b1c7>::</span><span style=color:#aa89ea>Function</span><span style=color:#54b1c7>::</span><span style=color:#aa89ea>Create</span><span style=color:#abb2bf>(</span>
</span></span><span style=display:flex><span>    <span style=color:#aa89ea>mainFuncType</span><span style=color:#abb2bf>,</span>
</span></span><span style=display:flex><span>    <span style=color:#aa89ea>llvm</span><span style=color:#54b1c7>::</span><span style=color:#aa89ea>GlobalValue</span><span style=color:#54b1c7>::</span><span style=color:#aa89ea>ExternalLinkage</span><span style=color:#abb2bf>,</span>
</span></span><span style=display:flex><span>    <span style=color:#98c379>&#34;main&#34;</span><span style=color:#abb2bf>,</span>
</span></span><span style=display:flex><span>    <span style=color:#aa89ea>module</span><span style=color:#abb2bf>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#aa89ea>mainFunc</span><span style=color:#54b1c7>-&gt;</span><span style=color:#aa89ea>setCallingConv</span><span style=color:#abb2bf>(</span><span style=color:#aa89ea>llvm</span><span style=color:#54b1c7>::</span><span style=color:#aa89ea>CallingConv</span><span style=color:#54b1c7>::</span><span style=color:#aa89ea>C</span><span style=color:#abb2bf>);</span>
</span></span></code></pre></div><h2 id=main関数の中へ省略気味>main関数の中へ(省略気味)
<a class=heading-link href=#main%e9%96%a2%e6%95%b0%e3%81%ae%e4%b8%ad%e3%81%b8%e7%9c%81%e7%95%a5%e6%b0%97%e5%91%b3><i class="fa-solid fa-link" aria-hidden=true title=見出しへのリンク></i>
<span class=sr-only>見出しへのリンク</span></a></h2><p>main関数の中に命令を並べる準備をしましょう。これも本質ではないので省略気味です。<br>これ以降、<code>Builder.CreateSomething</code>みたいな関数を呼ぶと、main関数内に挿入されるようになります。</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C++ data-lang=C++><span style=display:flex><span><span style=color:#76a9f9>auto</span> <span style=color:#aa89ea>mainBlock</span> <span style=color:#54b1c7>=</span> <span style=color:#aa89ea>llvm</span><span style=color:#54b1c7>::</span><span style=color:#aa89ea>BasicBlock</span><span style=color:#54b1c7>::</span><span style=color:#aa89ea>Create</span><span style=color:#abb2bf>(</span>
</span></span><span style=display:flex><span>    <span style=color:#aa89ea>context</span><span style=color:#abb2bf>,</span>
</span></span><span style=display:flex><span>    <span style=color:#98c379>&#34;entry&#34;</span><span style=color:#abb2bf>,</span>
</span></span><span style=display:flex><span>    <span style=color:#aa89ea>mainFunc</span>
</span></span><span style=display:flex><span><span style=color:#abb2bf>);</span>
</span></span><span style=display:flex><span><span style=color:#aa89ea>Builder</span><span style=color:#abb2bf>.</span><span style=color:#aa89ea>SetInsertPoint</span><span style=color:#abb2bf>(</span><span style=color:#aa89ea>mainBlock</span><span style=color:#abb2bf>);</span>
</span></span></code></pre></div><h2 id=floatで足し算をしよう>floatで足し算をしよう
<a class=heading-link href=#float%e3%81%a7%e8%b6%b3%e3%81%97%e7%ae%97%e3%82%92%e3%81%97%e3%82%88%e3%81%86><i class="fa-solid fa-link" aria-hidden=true title=見出しへのリンク></i>
<span class=sr-only>見出しへのリンク</span></a></h2><p>やっと本題です。まずは、足し算に使用する値を用意しましょう。</p><p>1行目ではFloatのサイズだけメモリをAllocateしています。この時の戻り値が表現している型はポインターなので注意です。<br>2行目では値を初期化しています。定数値を定義してStoreするという形で実現します。</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C++ data-lang=C++><span style=display:flex><span><span style=color:#76a9f9>auto</span> <span style=color:#aa89ea>f1PtrVal</span> <span style=color:#54b1c7>=</span> <span style=color:#aa89ea>Builder</span><span style=color:#abb2bf>.</span><span style=color:#aa89ea>CreateAlloca</span><span style=color:#abb2bf>(</span>
</span></span><span style=display:flex><span>    <span style=color:#aa89ea>LLVM_FLOAT_TY</span><span style=color:#abb2bf>,</span>
</span></span><span style=display:flex><span>    <span style=color:#aa89ea>llvm</span><span style=color:#54b1c7>::</span><span style=color:#aa89ea>ConstantInt</span><span style=color:#54b1c7>::</span><span style=color:#aa89ea>get</span><span style=color:#abb2bf>(</span><span style=color:#aa89ea>LLVM_INT32_TY</span><span style=color:#abb2bf>,</span> <span style=color:#d19a66>1</span><span style=color:#abb2bf>)</span>
</span></span><span style=display:flex><span><span style=color:#abb2bf>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#aa89ea>Builder</span><span style=color:#abb2bf>.</span><span style=color:#aa89ea>CreateStore</span><span style=color:#abb2bf>(</span>
</span></span><span style=display:flex><span>    <span style=color:#aa89ea>llvm</span><span style=color:#54b1c7>::</span><span style=color:#aa89ea>ConstantFP</span><span style=color:#54b1c7>::</span><span style=color:#aa89ea>get</span><span style=color:#abb2bf>(</span><span style=color:#aa89ea>LLVM_FLOAT_TY</span><span style=color:#abb2bf>,</span> <span style=color:#d19a66>3.5</span><span style=color:#abb2bf>),</span>
</span></span><span style=display:flex><span>    <span style=color:#aa89ea>f1PtrVal</span>
</span></span><span style=display:flex><span><span style=color:#abb2bf>);</span>
</span></span></code></pre></div><p>f1と同じようにf2を定義したものとします。(f1, f2って何ぞや、とおもった人は上にある目標のC言語コードを読んでください。)<br>足し算はポインター同士ではできないので、二つの値をLoadしてあげてFAdd命令で実現します。</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C++ data-lang=C++><span style=display:flex><span><span style=color:#76a9f9>auto</span> <span style=color:#aa89ea>f1Val</span> <span style=color:#54b1c7>=</span> <span style=color:#aa89ea>Builder</span><span style=color:#abb2bf>.</span><span style=color:#aa89ea>CreateLoad</span><span style=color:#abb2bf>(</span><span style=color:#aa89ea>f1PtrVal</span><span style=color:#abb2bf>);</span>
</span></span><span style=display:flex><span><span style=color:#76a9f9>auto</span> <span style=color:#aa89ea>f2Val</span> <span style=color:#54b1c7>=</span> <span style=color:#aa89ea>Builder</span><span style=color:#abb2bf>.</span><span style=color:#aa89ea>CreateLoad</span><span style=color:#abb2bf>(</span><span style=color:#aa89ea>f2PtrVal</span><span style=color:#abb2bf>);</span>
</span></span><span style=display:flex><span><span style=color:#76a9f9>auto</span> <span style=color:#aa89ea>calcVal</span> <span style=color:#54b1c7>=</span> <span style=color:#aa89ea>Builder</span><span style=color:#abb2bf>.</span><span style=color:#aa89ea>CreateFAdd</span><span style=color:#abb2bf>(</span><span style=color:#aa89ea>f1Val1</span><span style=color:#abb2bf>,</span> <span style=color:#aa89ea>f2Val2</span><span style=color:#abb2bf>);</span>
</span></span></code></pre></div><h2 id=printfをいよいよ呼び出そう-しかし>printfをいよいよ呼び出そう しかし&mldr;
<a class=heading-link href=#printf%e3%82%92%e3%81%84%e3%82%88%e3%81%84%e3%82%88%e5%91%bc%e3%81%b3%e5%87%ba%e3%81%9d%e3%81%86-%e3%81%97%e3%81%8b%e3%81%97><i class="fa-solid fa-link" aria-hidden=true title=見出しへのリンク></i>
<span class=sr-only>見出しへのリンク</span></a></h2><p>まずformatの文字列を定義します。Constantな文字列でやっていくので、<code>CreateGlobalStringPtr</code>に投げます。戻り値は、Int8型のポインターを表現したものです。</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C++ data-lang=C++><span style=display:flex><span><span style=color:#76a9f9>auto</span> <span style=color:#aa89ea>formatVal</span> <span style=color:#54b1c7>=</span> <span style=color:#aa89ea>Builder</span><span style=color:#abb2bf>.</span><span style=color:#aa89ea>CreateGlobalStringPtr</span><span style=color:#abb2bf>(</span><span style=color:#98c379>&#34;%f + %f = %f&#34;</span><span style=color:#abb2bf>);</span>
</span></span></code></pre></div><p>皆さんお待ちかね、遂にprintfを呼び出します。<br>printfを呼び出す命令に引数たちをvectorに詰めたものを渡します。</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C++ data-lang=C++><span style=display:flex><span><span style=color:#aa89ea>std</span><span style=color:#54b1c7>::</span><span style=color:#aa89ea>vector</span><span style=color:#54b1c7>&lt;</span><span style=color:#aa89ea>llvm</span><span style=color:#54b1c7>::</span><span style=color:#aa89ea>Value</span><span style=color:#54b1c7>*&gt;</span> <span style=color:#aa89ea>args</span><span style=color:#abb2bf>;</span>
</span></span><span style=display:flex><span><span style=color:#aa89ea>args</span><span style=color:#abb2bf>.</span><span style=color:#aa89ea>push_back</span><span style=color:#abb2bf>(</span><span style=color:#aa89ea>formatVal</span><span style=color:#abb2bf>);</span>
</span></span><span style=display:flex><span><span style=color:#aa89ea>args</span><span style=color:#abb2bf>.</span><span style=color:#aa89ea>push_back</span><span style=color:#abb2bf>(</span><span style=color:#aa89ea>f1Val</span><span style=color:#abb2bf>);</span>
</span></span><span style=display:flex><span><span style=color:#aa89ea>args</span><span style=color:#abb2bf>.</span><span style=color:#aa89ea>push_back</span><span style=color:#abb2bf>(</span><span style=color:#aa89ea>f2Val</span><span style=color:#abb2bf>);</span>
</span></span><span style=display:flex><span><span style=color:#aa89ea>args</span><span style=color:#abb2bf>.</span><span style=color:#aa89ea>push_back</span><span style=color:#abb2bf>(</span><span style=color:#aa89ea>calcVal</span><span style=color:#abb2bf>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#aa89ea>Builder</span><span style=color:#abb2bf>.</span><span style=color:#aa89ea>CreateCall</span><span style=color:#abb2bf>(</span><span style=color:#aa89ea>printfFunc</span><span style=color:#abb2bf>,</span> <span style=color:#aa89ea>args</span><span style=color:#abb2bf>);</span>
</span></span></code></pre></div><p>main関数に対するRet命令を加えましょう。Int32の0を戻り値として返しています。</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C++ data-lang=C++><span style=display:flex><span><span style=color:#aa89ea>Builder</span><span style=color:#abb2bf>.</span><span style=color:#aa89ea>CreateRet</span><span style=color:#abb2bf>(</span><span style=color:#aa89ea>llvm</span><span style=color:#54b1c7>::</span><span style=color:#aa89ea>Constant</span><span style=color:#54b1c7>::</span><span style=color:#aa89ea>getNullValue</span><span style=color:#abb2bf>(</span><span style=color:#aa89ea>LLVM_INT32_TY</span><span style=color:#abb2bf>));</span>
</span></span></code></pre></div><p>これまでに定義した命令たちをLLVM IRとして書き込んで出力しましょう。<br>この出力方法なんですが、それっぽい名前の関数をドキュメントから探して動かしてみたら動いた、というものなので、正しい方法を知っている方、ぜひコメントで教えてください。</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C++ data-lang=C++><span style=display:flex><span><span style=color:#aa89ea>llvm</span><span style=color:#54b1c7>::</span><span style=color:#aa89ea>verifyModule</span><span style=color:#abb2bf>(</span><span style=color:#54b1c7>*</span><span style=color:#aa89ea>module</span><span style=color:#abb2bf>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#aa89ea>std</span><span style=color:#54b1c7>::</span><span style=color:#aa89ea>error_code</span> <span style=color:#aa89ea>errorcode</span><span style=color:#abb2bf>;</span>
</span></span><span style=display:flex><span><span style=color:#76a9f9>auto</span> <span style=color:#aa89ea>stream</span> <span style=color:#54b1c7>=</span> <span style=color:#76a9f9>new</span> <span style=color:#aa89ea>llvm</span><span style=color:#54b1c7>::</span><span style=color:#aa89ea>raw_fd_ostream</span><span style=color:#abb2bf>(</span><span style=color:#98c379>&#34;test.ll&#34;</span><span style=color:#abb2bf>,</span> <span style=color:#aa89ea>errorcode</span><span style=color:#abb2bf>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#aa89ea>module</span><span style=color:#54b1c7>-&gt;</span><span style=color:#aa89ea>print</span><span style=color:#abb2bf>(</span><span style=color:#54b1c7>*</span><span style=color:#aa89ea>stream</span><span style=color:#abb2bf>,</span> <span style=color:#76a9f9>nullptr</span><span style=color:#abb2bf>);</span>
</span></span></code></pre></div><h2 id=実行すると>実行すると&mldr;
<a class=heading-link href=#%e5%ae%9f%e8%a1%8c%e3%81%99%e3%82%8b%e3%81%a8><i class="fa-solid fa-link" aria-hidden=true title=見出しへのリンク></i>
<span class=sr-only>見出しへのリンク</span></a></h2><p>このC++のコードを実行すると、同じディレクトリ内に<code>test.ll</code>というLLVM IRのファイルができているはずです。<br>続けてLLVM IRのファイルを実行してみましょう。<code>lli</code>を使用します。</p><p><code>lli</code>がインストールされていない方は、以下を参考にしてください。</p><p><a href=https://caphosra.net/posts/llvm-lli-install/>LLVMをWindowsで使いたくて入れたらlliなかった話</a></p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ lli test.ll
</span></span><span style=display:flex><span>0.000000 + 0.000000 <span style=color:#54b1c7>=</span> 0.000000
</span></span></code></pre></div><p>実行結果はこんな感じになったと思います。<br>なんということでしょう。出力の値が0になってしまいました。</p><h2 id=なぜ0になってしまったのか>なぜ0になってしまったのか
<a class=heading-link href=#%e3%81%aa%e3%81%9c0%e3%81%ab%e3%81%aa%e3%81%a3%e3%81%a6%e3%81%97%e3%81%be%e3%81%a3%e3%81%9f%e3%81%ae%e3%81%8b><i class="fa-solid fa-link" aria-hidden=true title=見出しへのリンク></i>
<span class=sr-only>見出しへのリンク</span></a></h2><p>この理由は実は私も最初全く分かりませんでした。<br>printfに原因があるのではないか、と思い、調べてみると気になる記事を見つけました。</p><p><a href=https://qiita.com/lo48576/items/9901f7d52692567b931c class=external-link target=_blank rel=noopener>Qitta - printf() に float/double を渡したときの挙動と %lf の意義 @lo48576</a></p><p>printfにおける<code>%f</code>は実はdouble型を出力するもので、float型を投げるとdouble型にCastされるようです。<br>LLVM IRによってこのCastが行われずに、Float型がDouble型として読まれて0になってしまった、という仮説が頭に浮かびます。(結果的に正しかったみたいです。)</p><h2 id=表示する前にdouble型にcastする>表示する前にDouble型にCastする
<a class=heading-link href=#%e8%a1%a8%e7%a4%ba%e3%81%99%e3%82%8b%e5%89%8d%e3%81%abdouble%e5%9e%8b%e3%81%abcast%e3%81%99%e3%82%8b><i class="fa-solid fa-link" aria-hidden=true title=見出しへのリンク></i>
<span class=sr-only>見出しへのリンク</span></a></h2><p>自動でDouble型にしてくれないのであれば、自分でDouble型にしたいと思います。<br>FPExt命令を利用しましょう。これを使うと、浮動小数点数の型をより大きいものへ変更できます。(厳密にはCastではない気がしますが&mldr;)</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C++ data-lang=C++><span style=display:flex><span><span style=color:#76a9f9>auto</span> <span style=color:#aa89ea>f1DoubleVal</span> <span style=color:#54b1c7>=</span> <span style=color:#aa89ea>Builder</span><span style=color:#abb2bf>.</span><span style=color:#aa89ea>CreateFPExt</span><span style=color:#abb2bf>(</span><span style=color:#aa89ea>f1Val</span><span style=color:#abb2bf>,</span> <span style=color:#aa89ea>LLVM_DOUBLE_TY</span><span style=color:#abb2bf>)</span>
</span></span></code></pre></div><p>後は、先ほどのprintfを呼び出した部分の値を以下のように置き換えます。</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C++ data-lang=C++><span style=display:flex><span><span style=color:#aa89ea>std</span><span style=color:#54b1c7>::</span><span style=color:#aa89ea>vector</span><span style=color:#54b1c7>&lt;</span><span style=color:#aa89ea>llvm</span><span style=color:#54b1c7>::</span><span style=color:#aa89ea>Value</span><span style=color:#54b1c7>*&gt;</span> <span style=color:#aa89ea>args</span><span style=color:#abb2bf>;</span>
</span></span><span style=display:flex><span><span style=color:#aa89ea>args</span><span style=color:#abb2bf>.</span><span style=color:#aa89ea>push_back</span><span style=color:#abb2bf>(</span><span style=color:#aa89ea>formatVal</span><span style=color:#abb2bf>);</span>
</span></span><span style=display:flex><span><span style=color:#aa89ea>args</span><span style=color:#abb2bf>.</span><span style=color:#aa89ea>push_back</span><span style=color:#abb2bf>(</span><span style=color:#aa89ea>f1DoubleVal</span><span style=color:#abb2bf>);</span>
</span></span><span style=display:flex><span><span style=color:#aa89ea>args</span><span style=color:#abb2bf>.</span><span style=color:#aa89ea>push_back</span><span style=color:#abb2bf>(</span><span style=color:#aa89ea>f2DoubleVal</span><span style=color:#abb2bf>);</span>
</span></span><span style=display:flex><span><span style=color:#aa89ea>args</span><span style=color:#abb2bf>.</span><span style=color:#aa89ea>push_back</span><span style=color:#abb2bf>(</span><span style=color:#aa89ea>calcDoubleVal</span><span style=color:#abb2bf>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#aa89ea>Builder</span><span style=color:#abb2bf>.</span><span style=color:#aa89ea>CreateCall</span><span style=color:#abb2bf>(</span><span style=color:#aa89ea>printfFunc</span><span style=color:#abb2bf>,</span> <span style=color:#aa89ea>args</span><span style=color:#abb2bf>);</span>
</span></span></code></pre></div><p>この変更を加えた後、実行してLLVM IRのファイルを入手し、それを実行すると&mldr;</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ lli test.ll
</span></span><span style=display:flex><span>3.500000 + 6.400000 <span style=color:#54b1c7>=</span> 9.900000
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#8a93a5;font-style:italic>#include</span> <span style=color:#8a93a5;font-style:italic>&lt;stdio.h&gt;</span><span style=color:#8a93a5;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#e5c07b>int</span> <span style=color:#00b1f7>main</span><span style=color:#abb2bf>()</span> <span style=color:#abb2bf>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e5c07b>float</span> <span style=color:#aa89ea>f1</span> <span style=color:#54b1c7>=</span> <span style=color:#d19a66>3.5</span><span style=color:#abb2bf>;</span>
</span></span><span style=display:flex><span>    <span style=color:#e5c07b>float</span> <span style=color:#aa89ea>f2</span> <span style=color:#54b1c7>=</span> <span style=color:#d19a66>6.4</span><span style=color:#abb2bf>;</span>
</span></span><span style=display:flex><span>    <span style=color:#00b1f7>printf</span><span style=color:#abb2bf>(</span><span style=color:#98c379>&#34;%f + %f = %f</span><span style=color:#d26464;font-weight:700>\n</span><span style=color:#98c379>&#34;</span><span style=color:#abb2bf>,</span> <span style=color:#aa89ea>f1</span><span style=color:#abb2bf>,</span> <span style=color:#aa89ea>f2</span><span style=color:#abb2bf>,</span> <span style=color:#aa89ea>f1</span> <span style=color:#54b1c7>+</span> <span style=color:#aa89ea>f2</span><span style=color:#abb2bf>);</span>
</span></span><span style=display:flex><span>    <span style=color:#76a9f9>return</span> <span style=color:#d19a66>0</span><span style=color:#abb2bf>;</span>
</span></span><span style=display:flex><span><span style=color:#abb2bf>}</span>
</span></span></code></pre></div><p>遂に目標のC言語のコードと同じ出力を得ました。</p><p>ソースコード全文と出力されたLLVM IRは以下から見ることができます。</p><p><a href=https://gist.github.com/caphosra/9cd38e8658bb2d07cb9306b73435fada class=external-link target=_blank rel=noopener>コード全文</a></p><h2 id=まとめ>まとめ
<a class=heading-link href=#%e3%81%be%e3%81%a8%e3%82%81><i class="fa-solid fa-link" aria-hidden=true title=見出しへのリンク></i>
<span class=sr-only>見出しへのリンク</span></a></h2><p>printfでFloat型を表示したいときはDouble型にCastしてからにしましょう。</p></div><footer><div class=comments><script>let getTheme=window.localStorage&&window.localStorage.getItem("colorscheme"),themeInParams="";getTheme==null&&(themeInParams!==""&&themeInParams!=="auto"?getTheme=themeInParams:getTheme=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light");let theme=getTheme==="dark"?"github-dark":"github-light",s=document.createElement("script");s.src="https://utteranc.es/client.js",s.setAttribute("repo","caphosra/caphosra.github.io"),s.setAttribute("issue-term","title"),s.setAttribute("theme",theme),s.setAttribute("crossorigin","anonymous"),s.setAttribute("async",""),document.querySelector("div.comments").innerHTML="",document.querySelector("div.comments").appendChild(s)</script></div></footer></article></section></div><footer class=footer><section class=container><p>Footer? なにそれ美味しいの?</p>© 2019 - 2024
caphosra</section></footer></main></body></html>