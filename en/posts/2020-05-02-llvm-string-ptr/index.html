<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="caphosra"><meta name=description content="I encountered the situaton that CreateGlobalStringPtr failed in the block of if statement, so I will introduce the way to solve it."><meta name=keywords content="CreateGlobalStringPtr,LLVM,crash,failed,error"><meta name=twitter:card content="summary"><meta name=twitter:image content="https://caphosra.net/images/icon.webp"><meta name=twitter:title content="[LLVM] How to solve CreateGlobalStringPtr crash"><meta name=twitter:description content="I encountered the situaton that CreateGlobalStringPtr failed in the block of if statement, so I will introduce the way to solve it."><meta property="og:url" content="https://caphosra.net/en/posts/2020-05-02-llvm-string-ptr/"><meta property="og:site_name" content="caphosra note"><meta property="og:title" content="[LLVM] How to solve CreateGlobalStringPtr crash"><meta property="og:description" content="I encountered the situaton that CreateGlobalStringPtr failed in the block of if statement, so I will introduce the way to solve it."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-05-02T07:51:32+09:00"><meta property="article:modified_time" content="2024-01-07T13:18:38+09:00"><meta property="article:tag" content="LLVM"><meta property="article:tag" content="CPlusPlus"><base href=https://caphosra.net/en/posts/2020-05-02-llvm-string-ptr/><title>[LLVM] How to solve CreateGlobalStringPtr crash · caphosra note
</title><link rel=canonical href=https://caphosra.net/en/posts/2020-05-02-llvm-string-ptr/><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css integrity="sha256-l85OmPOjvil/SOvVt3HnSSjzF1TUMyT9eV0c2BzEGzU=" crossorigin=anonymous><style defer>@import 'https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;700&display=swap'</style><link rel=stylesheet href=https://caphosra.net/css/coder.min.70f3e69b472ec0878dad3a4928700ac7d4dc99e9a09a656210c5862dcf0acfe7.css integrity="sha256-cPPmm0cuwIeNrTpJKHAKx9TcmemgmmViEMWGLc8Kz+c=" crossorigin=anonymous media=screen><script src=https://cdn.jsdelivr.net/npm/gist-embed@1.0.3/dist/gist-embed.min.js defer></script><link rel=icon type=image/png href=https://caphosra.net/images/logo/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=https://caphosra.net/images/logo/favicon-16x16.png sizes=16x16><meta name=generator content="Hugo 0.139.3"><style type=text/css>.icon{font-size:2.5em}</style></head><body class=colorscheme-light><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=https://caphosra.net/en/>caphosra note
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa-solid fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=https://caphosra.net/en/>About</a></li><li class=navigation-item><a class=navigation-link href=https://caphosra.net/en/posts/>Blog</a></li><li class=navigation-item><a class=navigation-link href=https://caphosra.net/en/tags/>Tags</a></li><li class=navigation-item><a class=navigation-link href=https://github.com/caphosra>GitHub</a></li><li class="navigation-item menu-separator"><span>|</span></li><li class=navigation-item><a href=https://caphosra.net/posts/2020-05-02-llvm-string-ptr/>日本語</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://caphosra.net/en/posts/2020-05-02-llvm-string-ptr/>[LLVM] How to solve CreateGlobalStringPtr crash</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa-solid fa-calendar" aria-hidden=true></i>
<time datetime=2020-05-02T07:51:32+09:00>May 2, 2020
</time></span><span class=reading-time><i class="fa-solid fa-clock" aria-hidden=true></i>
2-minute read</span></div><div class=tags><i class="fa-solid fa-tag" aria-hidden=true></i>
<span class=tag><a href=https://caphosra.net/en/tags/llvm/>LLVM</a>
</span><span class=separator>•</span>
<span class=tag><a href=https://caphosra.net/en/tags/cplusplus/>CPlusPlus</a></span></div></div></header><div class=post-content><p>I encountered the situaton that CreateGlobalStringPtr failed in the block of if statement, so I will introduce the way to solve it. (Also I found it had been my fault, but you can be.)</p><h2 id=the-error-that-occurred>The error that occurred
<a class=heading-link href=#the-error-that-occurred><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>First, let&rsquo;s implement if statements frankly.</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C++ data-lang=C++><span style=display:flex><span><span style=color:#76a9f9>auto</span> <span style=color:#aa89ea>ifblock</span> <span style=color:#54b1c7>=</span> <span style=color:#aa89ea>llvm</span><span style=color:#54b1c7>::</span><span style=color:#aa89ea>BasicBlock</span><span style=color:#54b1c7>::</span><span style=color:#aa89ea>Create</span><span style=color:#abb2bf>(</span><span style=color:#aa89ea>module</span><span style=color:#54b1c7>-&gt;</span><span style=color:#aa89ea>getContext</span><span style=color:#abb2bf>(),</span> <span style=color:#98c379>&#34;then&#34;</span><span style=color:#abb2bf>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#76a9f9>auto</span> <span style=color:#aa89ea>mergeblock</span> <span style=color:#54b1c7>=</span> <span style=color:#aa89ea>llvm</span><span style=color:#54b1c7>::</span><span style=color:#aa89ea>BasicBlock</span><span style=color:#54b1c7>::</span><span style=color:#aa89ea>Create</span><span style=color:#abb2bf>(</span><span style=color:#aa89ea>module</span><span style=color:#54b1c7>-&gt;</span><span style=color:#aa89ea>getContext</span><span style=color:#abb2bf>(),</span> <span style=color:#98c379>&#34;merged&#34;</span><span style=color:#abb2bf>);</span>
</span></span></code></pre></div><p>This is the part where we declare two Basic Blocks, one will be the inside of the if statement and the other will be the bottom of the end of the if statement.</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C++ data-lang=C++><span style=display:flex><span><span style=color:#aa89ea>builder</span><span style=color:#54b1c7>-&gt;</span><span style=color:#aa89ea>CreateCondBr</span><span style=color:#abb2bf>(</span><span style=color:#aa89ea>match</span><span style=color:#abb2bf>,</span> <span style=color:#aa89ea>ifblock</span><span style=color:#abb2bf>,</span> <span style=color:#aa89ea>mergeblock</span><span style=color:#abb2bf>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#aa89ea>builder</span><span style=color:#54b1c7>-&gt;</span><span style=color:#aa89ea>SetInsertPoint</span><span style=color:#abb2bf>(</span><span style=color:#aa89ea>ifblock</span><span style=color:#abb2bf>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#76a9f9>auto</span> <span style=color:#aa89ea>strptr</span> <span style=color:#54b1c7>=</span> <span style=color:#aa89ea>builder</span><span style=color:#54b1c7>-&gt;</span><span style=color:#aa89ea>CreateGlobalStringPtr</span><span style=color:#abb2bf>(</span><span style=color:#98c379>&#34;Hello World&#34;</span><span style=color:#abb2bf>);</span> <span style=color:#8a93a5;font-style:italic>// ERROR !
</span></span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#aa89ea>builder</span><span style=color:#54b1c7>-&gt;</span><span style=color:#aa89ea>CreateBr</span><span style=color:#abb2bf>(</span><span style=color:#aa89ea>mergeblock</span><span style=color:#abb2bf>);</span>
</span></span></code></pre></div><p>If it behaves as we expected, it will create a branch, do <code>SetInsertPoint</code> to the block named &ldquo;then&rdquo;, allocate the character string" Hello World" in the global space and get its pointer.</p><p>Assuming that you have done this operation in a function, it should be almost equivalent to the code below.</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C++ data-lang=C++><span style=display:flex><span><span style=color:#76a9f9>const</span> <span style=color:#e5c07b>char</span><span style=color:#54b1c7>*</span> <span style=color:#aa89ea>str</span> <span style=color:#54b1c7>=</span> <span style=color:#98c379>&#34;Hello World&#34;</span><span style=color:#abb2bf>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#e5c07b>void</span> <span style=color:#00b1f7>somefunc</span><span style=color:#abb2bf>()</span> <span style=color:#abb2bf>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e5c07b>bool</span> <span style=color:#aa89ea>match</span><span style=color:#abb2bf>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#76a9f9>if</span> <span style=color:#abb2bf>(</span><span style=color:#aa89ea>match</span><span style=color:#abb2bf>)</span> <span style=color:#abb2bf>{</span>
</span></span><span style=display:flex><span>        <span style=color:#8a93a5;font-style:italic>// Create global string poiter and it points &#34;HelloWorld&#34;.
</span></span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic></span>        <span style=color:#76a9f9>auto</span> <span style=color:#aa89ea>strptr</span> <span style=color:#54b1c7>=</span> <span style=color:#aa89ea>str</span><span style=color:#abb2bf>;</span>
</span></span><span style=display:flex><span>    <span style=color:#abb2bf>}</span>
</span></span><span style=display:flex><span><span style=color:#abb2bf>}</span>
</span></span></code></pre></div><p>But this code fails. Why.</p><h2 id=pay-attention-to-the-parent-function-of-basicblock>Pay attention to the parent function of BasicBlock!
<a class=heading-link href=#pay-attention-to-the-parent-function-of-basicblock><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>You may have realized. (I&rsquo;m not bright at all so it took me two hours to solve it&mldr;)
The parent functions of <code>ifblock</code> and <code>mergeblock</code> are not specified. The function, <code>BasicBlock::Create</code> can be used without specifying the parent function, so I wasn&rsquo;t noticed.</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C++ data-lang=C++><span style=display:flex><span><span style=color:#aa89ea>BasicBlock</span><span style=color:#54b1c7>::</span><span style=color:#aa89ea>Create</span><span style=color:#abb2bf>(</span><span style=color:#aa89ea>LLVMContext</span> <span style=color:#54b1c7>&amp;</span><span style=color:#aa89ea>Context</span><span style=color:#abb2bf>,</span> <span style=color:#76a9f9>const</span> <span style=color:#aa89ea>Twine</span> <span style=color:#54b1c7>&amp;</span><span style=color:#aa89ea>Name</span><span style=color:#54b1c7>=</span><span style=color:#98c379>&#34;&#34;</span><span style=color:#abb2bf>,</span> <span style=color:#aa89ea>Function</span> <span style=color:#54b1c7>*</span><span style=color:#aa89ea>Parent</span><span style=color:#54b1c7>=</span><span style=color:#76a9f9>nullptr</span><span style=color:#abb2bf>,</span> <span style=color:#aa89ea>BasicBlock</span> <span style=color:#54b1c7>*</span><span style=color:#aa89ea>InsertBefore</span><span style=color:#54b1c7>=</span><span style=color:#76a9f9>nullptr</span><span style=color:#abb2bf>);</span>
</span></span></code></pre></div><p><a href=https://llvm.org/doxygen/classllvm_1_1BasicBlock.html class=external-link target=_blank rel=noopener>llvm::BasicBlock Class Reference</a></p><p>Some operations can be performed without specifying the parent function, but calling <code>CreateGlobalStringPtr</code> requires the parent function and BasicBlock.</p><p>In summary, it means that you cannot call <code>CreateGlobalStringPtr</code> without specifying the parent function.</p><h2 id=tips-get-the-currently-inserted-function>[Tips] Get the currently inserted function
<a class=heading-link href=#tips-get-the-currently-inserted-function><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>It can be done by getting the current BasicBlock and then its parent function.</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C++ data-lang=C++><span style=display:flex><span><span style=color:#76a9f9>auto</span> <span style=color:#aa89ea>parent</span> <span style=color:#54b1c7>=</span> <span style=color:#aa89ea>builder</span><span style=color:#54b1c7>-&gt;</span><span style=color:#aa89ea>GetInsertBlock</span><span style=color:#abb2bf>()</span><span style=color:#54b1c7>-&gt;</span><span style=color:#aa89ea>getParent</span><span style=color:#abb2bf>();</span>
</span></span></code></pre></div><p>Now, we found that just rewriting like this fix the error.</p><div class=highlight><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C++ data-lang=C++><span style=display:flex><span><span style=color:#76a9f9>auto</span> <span style=color:#aa89ea>ifblock</span> <span style=color:#54b1c7>=</span> <span style=color:#aa89ea>llvm</span><span style=color:#54b1c7>::</span><span style=color:#aa89ea>BasicBlock</span><span style=color:#54b1c7>::</span><span style=color:#aa89ea>Create</span><span style=color:#abb2bf>(</span><span style=color:#aa89ea>module</span><span style=color:#54b1c7>-&gt;</span><span style=color:#aa89ea>getContext</span><span style=color:#abb2bf>(),</span> <span style=color:#98c379>&#34;then&#34;</span><span style=color:#abb2bf>,</span> <span style=color:#aa89ea>parent</span><span style=color:#abb2bf>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#76a9f9>auto</span> <span style=color:#aa89ea>mergeblock</span> <span style=color:#54b1c7>=</span> <span style=color:#aa89ea>llvm</span><span style=color:#54b1c7>::</span><span style=color:#aa89ea>BasicBlock</span><span style=color:#54b1c7>::</span><span style=color:#aa89ea>Create</span><span style=color:#abb2bf>(</span><span style=color:#aa89ea>module</span><span style=color:#54b1c7>-&gt;</span><span style=color:#aa89ea>getContext</span><span style=color:#abb2bf>(),</span> <span style=color:#98c379>&#34;merged&#34;</span><span style=color:#abb2bf>,</span> <span style=color:#aa89ea>parent</span><span style=color:#abb2bf>);</span>
</span></span></code></pre></div></div><footer><div class=comments><script>let getTheme=window.localStorage&&window.localStorage.getItem("colorscheme"),themeInParams="";getTheme==null&&(themeInParams!==""&&themeInParams!=="auto"?getTheme=themeInParams:getTheme=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light");let theme=getTheme==="dark"?"github-dark":"github-light",s=document.createElement("script");s.src="https://utteranc.es/client.js",s.setAttribute("repo","caphosra/caphosra.github.io"),s.setAttribute("issue-term","title"),s.setAttribute("theme",theme),s.setAttribute("crossorigin","anonymous"),s.setAttribute("async",""),document.querySelector("div.comments").innerHTML="",document.querySelector("div.comments").appendChild(s)</script></div></footer></article></section></div><footer class=footer><section class=container><p>Footer...? I don't know what it is.</p>© 2019 - 2024
caphosra</section></footer></main></body></html>